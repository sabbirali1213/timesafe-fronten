<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Timing Test - TimeSafe Delivery</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9fafb;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #059669;
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-order {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9fafb;
        }
        .refresh-button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .refresh-button:hover {
            background: #047857;
        }
        .status {
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è∞ TimeSafe Delivery - Vendor Timing Test</h1>
        
        <div class="status">
            <strong>Test Status:</strong> <span id="test-status">Loading...</span><br>
            <strong>Backend URL:</strong> <span id="backend-url">Loading...</span><br>
            <strong>Last Update:</strong> <span id="last-update">Never</span>
        </div>
        
        <button class="refresh-button" onclick="fetchOrdersTest()">üîÑ Fetch Fresh Orders</button>
        <button class="refresh-button" onclick="clearCache()">üóëÔ∏è Clear Cache & Refresh</button>
        
        <div id="orders-container">
            <p>Click "Fetch Fresh Orders" to test real-time order data...</p>
        </div>
        
        <div class="demo-order">
            <h3>üß™ Demo Order (Created Just Now)</h3>
            <div id="demo-timing"></div>
            <p><small>This simulates an order created right now to test real-time timing.</small></p>
        </div>
    </div>

    <script>
        // Get backend URL from environment or use default
        const BACKEND_URL = window.location.origin;
        document.getElementById('backend-url').textContent = BACKEND_URL;
        
        // Demo order timestamp
        const demoOrderTime = new Date().toISOString();
        
        // Simple LiveTimestamp implementation
        function updateDemoTiming() {
            const now = Date.now();
            const orderDate = new Date(demoOrderTime);
            const diffMs = now - orderDate.getTime();
            const diffSec = Math.max(0, Math.floor(diffMs / 1000));
            
            let display = '';
            if (diffSec < 60) {
                display = `${diffSec}s ago`;
            } else if (diffSec < 3600) {
                const m = Math.floor(diffSec / 60);
                const s = diffSec % 60;
                display = `${m}m ${s}s ago`;
            } else {
                const h = Math.floor(diffSec / 3600);
                const m = Math.floor((diffSec % 3600) / 60);
                const s = diffSec % 60;
                display = `${h}h ${m}m ${s}s ago`;
            }
            
            document.getElementById('demo-timing').innerHTML = `
                <div style="background: #dcfce7; color: #166534; padding: 8px; border-radius: 4px; font-family: monospace; font-weight: bold;">
                    üÜï ${display} (Updates every second)
                </div>
            `;
        }
        
        // Update demo timing every second
        setInterval(updateDemoTiming, 1000);
        updateDemoTiming();
        
        // Test function to fetch orders
        async function fetchOrdersTest() {
            const statusEl = document.getElementById('test-status');
            const ordersEl = document.getElementById('orders-container');
            const lastUpdateEl = document.getElementById('last-update');
            
            try {
                statusEl.textContent = 'Fetching orders...';
                
                // Add cache busting
                const timestamp = Date.now();
                const response = await fetch(`${BACKEND_URL}/api/orders?_t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.status === 401) {
                    statusEl.textContent = '‚ùå Authentication required (expected for public test)';
                    ordersEl.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; color: #991b1b;">
                            <h3>üîê Authentication Required</h3>
                            <p>This test needs a valid vendor token to fetch orders. The cache-busting functionality is working (note the timestamp in URL: _t=${timestamp}).</p>
                            <p><strong>Good news:</strong> If you can see the demo timing above updating every second, the LiveTimestamp component is working correctly!</p>
                        </div>
                    `;
                } else if (response.ok) {
                    const orders = await response.json();
                    statusEl.textContent = `‚úÖ Success! Fetched ${orders.length} orders`;
                    
                    ordersEl.innerHTML = orders.map(order => `
                        <div class="demo-order">
                            <h4>Order #${order.id.slice(0, 8)}</h4>
                            <p>Status: ${order.status}</p>
                            <p>Created: ${new Date(order.created_at).toLocaleString()}</p>
                            <p>Total: ‚Çπ${order.total_amount}</p>
                        </div>
                    `).join('');
                } else {
                    statusEl.textContent = `‚ùå Error: ${response.status} ${response.statusText}`;
                }
                
                lastUpdateEl.textContent = new Date().toLocaleString();
                
            } catch (error) {
                statusEl.textContent = `‚ùå Network error: ${error.message}`;
                ordersEl.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function clearCache() {
            // Clear various types of cache
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Force reload with no cache
            location.reload(true);
        }
        
        // Auto-fetch on page load
        setTimeout(fetchOrdersTest, 1000);
    </script>
</body>
</html>